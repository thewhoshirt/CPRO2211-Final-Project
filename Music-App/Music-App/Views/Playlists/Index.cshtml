<!-- import the playlist model -->
@model Music_App.Models.Playlist
@{
    ViewData["Title"] = "Index";
    var InPlaylist = ViewBag.InPlaylist; // get the songs in the first playlist since thats the default index page
}
<h1>Index</h1>
<!-- buttons to let the users go back the main page, the database, or the playlist database views -->
<nav>
    <a class="btn btn-dark" asp-controller="Musics" asp-action="Index">Home</a>
    <a class="btn btn-dark" asp-controller="Musics" asp-action="Database">All songs</a>
    <a class="btn btn-secondary" asp-controller="Playlists" asp-action="Database">All playlists</a>
</nav>
<!--
if the playlist is not empty, create a table that shows the songs in the playlist as a table that shows the title, artist, and track length
otherwise tell the user to select a playlist
-->
@if (InPlaylist != null)
{
    <h2>@Model.PlaylistName</h2>
    <table class="table">
    <thead>
        <tr>
            <th>
                TrackTitle
            </th>
            <th>
                TrackArtist
            </th>
            <th>
                TrackLength
            </th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in InPlaylist)
        {
            <tr>
                <td>
                    @item.TrackTitle
                </td>
                <td>
                    @item.TrackArtist
                </td>
                <td>
                    @item.TrackLength
                </td>
            </tr>
        }
        </tbody>
    </table>
}
else
{
    <p>Select a playlist</p>
}
<!-- 
with the exception of using the playlistID instead of the trackID, the following code is identical to the index page
of the Musics controller
-->
<div style="margin-bottom:10px">
    <progress id="playback-progress" value="0" max="100"></progress>
    <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
</div>
<div>
    <p>Playing: <span id="trackInfo"></span></p>
</div>
<button class="btn btn-success" onclick="playPlaylist(@Model.PlaylistId)">Play</button>
<button class="btn btn-outline-secondary" onclick="rewindAudio()"><<</button>
<button class="btn btn-outline-secondary" onclick="pauseAudio()">Pause</button>
<button class="btn btn-danger" onclick="stopAudio()">Stop</button>
<button class="btn btn-outline-secondary" onclick="forwardAudio()">>></button>
<button class="btn btn-outline-secondary" onclick="raiseAudio()">Vol up</button>
<button class="btn btn-outline-secondary" onclick="lowerAudio()">Vol dwn</button>
<div>
    <script>
            function playPlaylist(playlistid) {
            fetch(`/playlist/${playlistid}`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message === "Audio is playing") {
                        document.getElementById('trackInfo').innerText = `${data.trackTitle} by ${data.trackArtist}`;
                        console.log('Audio is playing');
                    } else {
                        console.error('Error: Audio could not be started');
                    }
                })
                .catch(err => console.error('Error:', err));
        }

            function stopAudio() {
            fetch('/stop', {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    console.log('Audio stopped');
                    document.getElementById('trackInfo').innerText = '';  // Reset the track info when stopped
                }
            }).catch(err => console.error('Error:', err));
        }

            function pauseAudio() {
            fetch('/pause', {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    console.log('Audio paused');
                }
            }).catch(err => console.error('Error:', err));
        }

            function rewindAudio() {
            fetch('/rewind', {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    console.log('Audio rewound');
                }
            }).catch(err => console.error('Error:', err));
        }

            function forwardAudio() {
            fetch('/forward', {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    console.log('Audio fast-forwarded');
                }
            }).catch(err => console.error('Error:', err));
        }


        function formatTime(seconds) {
            var mins = Math.floor(seconds / 60);
            var secs = Math.floor(seconds % 60);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }

        setInterval(function () {
            $.getJSON('/Musics/GetPlaybackProgress', function (data) {
                if(data.currentTime != null || data.totalTime != null) {
                    $('#playback-progress').val(data.percentage);
                    $('#current-time').text(formatTime(data.currentTime));
                    $('#total-time').text(formatTime(data.totalTime));
                    if(data.trackArtist != undefined && data.trackTitle != undefined){
                        document.getElementById('trackInfo').innerText = `${data.trackTitle} by ${data.trackArtist}`;
                    }
                    
                }
            });
        }, 1000)

         function raiseAudio() {
                fetch('/up', {
                    method: 'POST'
                }).then(response => {
                    if (response.ok) {
                        console.log('Volume raised');
                    }
                }).catch(err => console.error('Error:', err));
            }

            function lowerAudio() {
                fetch('/down', {
                    method: 'POST'
                }).then(response => {
                    if (response.ok) {
                        console.log('Volume lowered');
                    }
                }).catch(err => console.error('Error:', err));
            }

    </script>
</div>